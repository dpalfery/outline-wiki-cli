name: publish-npm

on:
  workflow_run:
    workflows: ["release"]
    types:
      - completed

  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish (e.g. v0.1.0)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  publish:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Verify tag matches package.json version
        working-directory: npm/outlinectl
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.event.workflow_run.head_branch }}"
          fi

          if [ -z "${TAG}" ]; then
            # Fallback: pick a v* tag pointing at this commit.
            TAG=$(git tag --points-at HEAD | grep -E '^v[0-9]+' | head -n 1 || true)
          fi

          if [ -z "${TAG}" ]; then
            echo "ERROR: Could not determine tag name for this workflow_run." >&2
            echo "This workflow is intended to run for tag-based releases (e.g. v0.1.0)." >&2
            exit 1
          fi

          VERSION_FROM_TAG="${TAG#v}"
          PKG_VERSION=$(node -p "require('./package.json').version")

          echo "Tag: ${TAG}"
          echo "Tag version: ${VERSION_FROM_TAG}"
          echo "package.json version: ${PKG_VERSION}"

          if [ "${VERSION_FROM_TAG}" != "${PKG_VERSION}" ]; then
            echo "ERROR: Tag version does not match npm/outlinectl/package.json version." >&2
            echo "Fix by updating npm/outlinectl/package.json version or tagging the matching version." >&2
            exit 1
          fi

      - name: Pack (sanity check)
        working-directory: npm/outlinectl
        run: npm pack --silent

      - name: Publish to npm
        working-directory: npm/outlinectl
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
